<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 7</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1800, 900, Phaser.AUTO, '', { preload: preload, create: create, update: update,  });
var horizontalScale = 1024/1920;
var verticalScale = 512/1080;
var distantBackground;
var closeBackground;
var midBackground;

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/fullfloor.png');
    game.load.image('car','assets/player.png');
    game.load.physics('carPhysics','assets/player.json')
    //game.load.image('obstacle','assets/rock.png');
    game.load.image('rock','assets/rock.png');
    game.load.image('middleBackground','assets/middleback.png');
    game.load.image('farBackground','assets/farback.png');
    game.load.image('nearBackground','assets/closeback.png');
    game.load.image('enemyTank','assets/tank.png');
    game.load.image('enemyFlying','assets/flier.png');
    game.load.image('bulletUp','assets/bulletup.png');
    game.load.image('crater','assets/craterfloor.png');
    game.load.image('projectile','assets/roundbullet.png');
    game.load.image('normalGround','assets/floor.png');
    game.load.image('groundEnemy','assets/tank.png');
    game.load.image('tankBullet','assets/bulletright.png');
}

var player;
var floorTiles;
var cursors;
var upBullets;
var upGun;
var obstacleRock;
var obstacleExists;
var generateObstacle;
var timer;
var random;
var flier;
var flierActive = false;
var tankActive = false;
var score;
var scoreText;
var craterTiles;
var craterPanel;
var craterPoint;
var screenSpeed;
var canPlayerJump;
var groundSprite;
var enemyWeapon;
var tankWeapon;
var tank;
var speedScale;


function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);
    //game.stage.backgroundColor = "#000000";
    obstacleExists = false;

	speedScale = 1;    
    //define point where new craters spawn
    craterPoint = new Phaser.Point();
    craterPoint.x = 1800;
    craterPoint.y = 863;
    screenSpeed = 600;
    //  adding the two backgrounds

    //game.physics.p2.gravity.y=1000;
   	var background = game.add.sprite(0,0,'sky');
    //background.scale.setTo(horizontalScale,verticalScale);
    
  	floorTiles = game.add.group();

    //  We will enable physics for any object that is created in this group
    floorTiles.enableBody = true;
  
    for(var i=0;i<20;i++)
    {
        groundPanel = floorTiles.create(i*193,(game.world.height-184*0.6),'ground');
        
        groundPanel.body.immovable = true;
        //groundPanel.scale.setTo(horizontalScale,verticalScale);
    }
    distantBackground = game.add.tileSprite(0,40,4096,1024,'farBackground',null);
    
  //distantBackground.scale.setTo(horizontalScale,verticalScale);
    midBackground = game.add.tileSprite(0,0,4096,1024,'middleBackground',null);
  // closeBackground.scale.setTo(horizontalScale,verticalScale);
  	closeBackground = game.add.tileSprite(0,80,4096,1024,'nearBackground',null);
  	groundSprite = game.add.tileSprite(0,-90,2048,1024,'normalGround',null);
    game.physics.arcade.enable(groundSprite);
    groundSprite.enableBody = true;
    groundSprite.body.immovable = true;

  	canPlayerJump = true;
    score = 0;

	

   

    //weapon to shoot 
    upGun = game.add.weapon(20,'projectile');
    upGun.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
    upGun.bulletSpeed = 1500;//change this for bullet speed
    upGun.fireRate = 700;//change this for maximum fire rate
    upGun.fireAngle = 300;//change this for firing angle
    upGun.bulletGravity.y = 2000;//change this value for gravity

 
   //i know it says weapon but this is what i'm using to generate obstacles. it basically shoots them from the right side of the screen towards the left
    obstacleGenerator = game.add.weapon(5,'rock');
    obstacleGenerator.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
    obstacleGenerator.bulletSpeed = screenSpeed * speedScale;//speed that the obstacles travel
    obstacleGenerator.fireAngle = 180;//don't change
    obstacleGenerator.fireFrom.x = 1800;//don't change
    obstacleGenerator.fireFrom.y = 780;//don't change
    obstacleGenerator.bulletAngleOffset = 180;//don't change
    obstacleGenerator.bullets.setAll('scale.x', 0.5);
	obstacleGenerator.bullets.setAll('scale.y', 0.5);
    
    //again, this says weapon, but i'm using this to spawn craters. works the same way as the obstacle generator
    craterGenerator = game.add.weapon(5,'crater');
    craterGenerator.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
    craterGenerator.bulletSpeed = screenSpeed * speedScale;//speed of the crater. try and keep it the same as the speed of the obstacle so it seems like we're moving at the same speed
    craterGenerator.fireAngle = 180;//don't change
    craterGenerator.bulletAngleOffset = 180;//don't change
    craterGenerator.bullets.setAll('scale.x', 0.5);
	craterGenerator.bullets.setAll('scale.y', 0.5);

	//Weapon attached to the flying enemies
	enemyWeapon = game.add.weapon(5,'bulletUp');
    enemyWeapon.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
    enemyWeapon.bulletSpeed = 500;//change this for bullet speed
    enemyWeapon.fireRate = 700;//change this for maximum fire rate
    enemyWeapon.fireAngle = 90;//change this for firing angle
    enemyWeapon.bulletGravity.y = 600;//change this value for gravit
    enemyWeapon.bulletAngleOffset = 180;

    tankWeapon = game.add.weapon(5,'tankBullet');
    tankWeapon.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
    tankWeapon.bulletSpeed = 700;//change this for bullet speed
    tankWeapon.fireRate = 700;//change this for maximum fire rate
    tankWeapon.fireAngle = 180;//change this for firing angle
    tankWeapon.bulletAngleOffset = 180;
    tankWeapon.bulletGravity.x = -500;

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 500, 'car');

    //  enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties.
    player.body.bounce.y = 0.05;//don't change
    player.body.gravity.y = 2800;//modify this to change player gravity
   //player.scale.setTo(horizontalScale,verticalScale);//don't change
    player.body.collideWorldBounds = true;//don't change
    
    //attach both guns to the player
    upGun.trackSprite(player,130,40);
    
   
    //random events to spawn the first enemy
    random = game.rnd.integerInRange(2,4);
    var random3 = game.rnd.integerInRange(3,5);

    game.time.events.add(1000*random,createObstacle);
    game.time.events.add(1000,createFlier);
    //game.time.events.add(1000*random3,generateCrater);
    game.time.events.add(1000*10,createTank);
    

    //  Our controls....
    cursors = game.input.keyboard.createCursorKeys();
    shootKey = game.input.keyboard.addKey(Phaser.KeyCode.S);
    scoreText = game.add.text(10,30,'Score:' + score,{font:"28px Arial",fill:"#ffffff", align:"center"});
    pauseKey = game.input.keyboard.addKey(Phaser.KeyCode.P);
    
}

function update() {

    //  code to handle all the collisions and call respective functions
    game.physics.arcade.collide(player, floorTiles);//so the player doesn't fall through the ground
    game.physics.arcade.collide(player, obstacleGenerator.bullets,destroyCollision);//player and rocks. destroys both and ends game
    game.physics.arcade.collide(upGun.bullets, flier, shootFlier);//bullets destroy flying enemies
    game.physics.arcade.collide(upGun.bullets,floorTiles, spawnCrater);//bullets hit the floor to create craters
    game.physics.arcade.collide(player,craterGenerator.bullets,destroyCollision);//player and crater collision. kills player, ends game
    game.physics.arcade.collide(upGun.bullets,obstacleGenerator.bullets,destroyObstacle);//bullet destroys rocks
    game.physics.arcade.collide(enemyWeapon.bullets,floorTiles, spawnCrater);
    game.physics.arcade.collide(player, enemyWeapon.bullets,destroyCollision);
    game.physics.arcade.collide(player, tankWeapon.bullets,destroyCollision);
    game.physics.arcade.collide(upGun.bullets, tank,destroyTank);
    //implementing parallax for the backgrounds
    distantBackground.tilePosition.x-=0.5*speedScale*1.3;
    midBackground.tilePosition.x-=0.75*speedScale*1.3;
    closeBackground.tilePosition.x-=1*speedScale*1.3;
    groundSprite.tilePosition.x-=10*speedScale;
    speedScale = 1+ player.body.position.x/1800;
    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;
    game.world.bringToTop(craterGenerator.bullets);
   if(tankActive){ game.world.bringToTop(tank);}//don't change. makes sure the craters are in FRONT of the ground
    score +=0.1;
 
   //player controls
    if (cursors.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -350;

        //player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        //  Move to the right
        player.body.velocity.x = 350;

       // player.animations.play('right');
    }
    if(shootKey.isDown)
    {
        upGun.fire();
    }
   
   //move the flying enemy
    if(flierActive)
    {
        flier.body.velocity.x = 0;
        moveFlier();
    }
    if(tankActive)
    {
    	moveTank();
    }

    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down && canPlayerJump)
    {
        player.body.velocity.y = -1100;
        canPlayerJump = false;
        game.time.events.add(800,jumpPlayer);
    }
    scoreText.text = 'Score:' + Math.round(score); //print score
    
}


function createTank()
{
	if(!tankActive)
    {//spawn the flier and set it's properties
    	tank = game.add.sprite(1900,680,'groundEnemy');//don't change
    	game.physics.arcade.enable(tank);
	    //tank.enableBody = true;
	   // flier.body.gravity.y = 0;
	    tankActive = true;
	    tank.scale.setTo(horizontalScale,verticalScale);
	    //game.time.events.add(9000,deleteFlier);//time limit for flier is 7 seconds
	    game.time.events.add(1000,tankShoot);
	    tankWeapon.trackSprite(tank);
	}
}
var tankSet = false;
function moveTank()
{
	if(tank.body.position.x>1600 && !tankSet){
		tank.body.position.x-=5;
	}
	if(tank.body.position.x =1600 && !tankSet)
	{
		tankSet = true;
	}
	if( tankSet)
	{
		tank.body.position.x = Math.sin(game.time.now/1000)*100+1500;
	}
}

function destroyTank(obj1,obj2)
{
	obj1.kill();
	obj2.kill();
	tankActive = false;
	game.time.events.add(4000,createTank);
	score+=400;
}

function tankShoot()
{	
	tankWeapon.bulletSpeed = 700 * speedScale;
	if(tankActive){tankWeapon.fire();}
	game.time.events.add(4000,tankShoot);
}

function jumpPlayer()
{
	canPlayerJump = true;
}

//randomly generated crater function

function generateCrater()
{
	craterGenerator.bulletSpeed = screenSpeed * speedScale;
	craterGenerator.fire(craterPoint);
	var random2 = game.rnd.integerInRange(4,6);//frequency of new craters in seconds
	game.time.events.add(random2*1000,generateCrater);
}


//generates crater where projectile hits the ground
function spawnCrater(obj1,obj2)
{
	craterGenerator.bulletSpeed = screenSpeed * speedScale;
	craterGenerator.fire(obj1,null,null,null,85);//don't change
	obj1.kill();
}


//mainly used for collisions that kill the player
function destroyCollision(obj1, obj2)
{
    obj1.kill();
    obj2.kill();
    var text = game.add.text(512,256,'Game Over',{font:"50px Arial",fill:"#ffffff", align:"center"});
    game.paused = true;
   // game.destroy();
}

// destroy obstacle when bullet hits it and craetes timer for new obstacle
function destroyObstacle(obj1, obj2)
{
    obj1.kill();
    obj2.kill();
    score+=100;
    random = game.rnd.integerInRange(1,2);//frequency of new rocks
    game.time.events.add(random*1000,createObstacle); // creates a random event to spawn the next obstacle
}

//when rock goes off screen, adds event to create new obstacle
function createObstacle()
{
    score+=100;
    obstacleGenerator.bulletSpeed = screenSpeed * speedScale;
    obstacleGenerator.fire();//spawn new obstacle
    random = game.rnd.integerInRange(4,6);//frequency of new rocks
    game.time.events.add(random*1000,createObstacle);
}

//create the flying enemy
function createFlier()
{
    if(!flierActive)
    {//spawn the flier and set it's properties
    	flier = game.add.sprite(900,-100,'enemyFlying');//don't change
    	game.physics.arcade.enable(flier);
	    flier.enableBody = true;
	   // flier.body.gravity.y = 0;
	    flierActive = true;
	    flier.scale.setTo(horizontalScale,verticalScale);
	    game.time.events.add(12000,deleteFlier);//time limit for flier is 7 seconds
	    game.time.events.add(4000,shootGun);
	    game.time.events.add(7000,shootGun);
	    enemyWeapon.trackSprite(flier);
	}
}

function shootGun()
{
	if(flierActive){
		enemyWeapon.fire();
	}
	

}
//for when you shoot the flier
function shootFlier(obj1,obj2)
{
    obj2.kill();
    obj1.kill();
    flierActive = false;
    score+=300;
    game.time.events.add(1000*game.rnd.integerInRange(6,9),createFlier);//random event to spawn the next flying obstacle
}


//destroys flier after some amount of time
function deleteFlier()
{
    flier.kill();
    flierActive = false;
    game.time.events.add(1000*game.rnd.integerInRange(6,9),createFlier);//random event to spawn the next flying enemy
}


//wave motion for the flying enemy
function moveFlier()
{
    flier.body.position.x = Math.sin(game.time.now/1000)*400+600;//don't change for now
    if(flier.body.position.y<400)
    {
    	flier.body.position.y+=1;
    }

}



</script>

</body>
</html>